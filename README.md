# 驾驶员危险行为与疲劳检测系统

## 项目简介

本项目是一个基于深度学习的驾驶员危险行为与疲劳检测系统，旨在通过计算机视觉技术实时监测驾驶员的状态，及时发现潜在的危险行为和疲劳状态，从而提高行车安全。

系统采用 **YOLOv8** 目标检测算法识别驾驶员的危险行为（如使用手机、吸烟、未系安全带等），同时结合 **Dlib** 面部特征点检测和 **Perclos** 疲劳评估模型，实现对驾驶员疲劳状态的实时监测。

![系统界面](icon/app.png)

## 核心功能

### 1. 危险行为检测
基于 YOLOv8 深度学习模型，系统可以实时检测以下驾驶员危险行为：
- **Open Eye（睁眼）**：正常驾驶状态
- **Closed Eye（闭眼）**：检测闭眼状态
- **Cigarette（吸烟）**：检测驾驶过程中的吸烟行为
- **Phone（使用手机）**：检测驾驶时使用手机
- **Seatbelt（安全带）**：检测安全带佩戴情况

### 2. 疲劳检测
采用面部特征点检测技术，实时监测驾驶员的疲劳状态：
- **眨眼检测**：基于眼睛长宽比（EAR）算法，统计眨眼频率
- **哈欠检测**：基于嘴巴长宽比（MAR）算法，检测打哈欠行为
- **Perclos 评估**：计算一定时间窗口内眼睛闭合的比例，科学评估疲劳程度
- **疲劳状态判定**：综合多项指标，实时判断"清醒状态"或"疲劳状态"

### 3. 多种输入模式
- **图片检测**：支持单张图片的危险行为识别
- **批量检测**：支持选择文件夹进行批量图片检测
- **视频检测**：支持 MP4、AVI 等格式视频文件的检测
- **实时摄像头**：支持实时摄像头监控，适用于实际应用场景

### 4. 可视化界面
基于 PyQt5 开发的图形化用户界面，提供：
- 清晰的检测结果展示
- 目标位置、类别、置信度等详细信息
- 检测历史记录表格
- 目标筛选功能
- 数据导出功能（支持 Excel 和 CSV 格式）

## 技术架构

### 深度学习框架
- **YOLOv8**：用于目标检测的主干网络
- **PyTorch**：深度学习框架
- **Ultralytics**：YOLOv8 的官方实现库

### 计算机视觉
- **OpenCV**：图像处理和视频流处理
- **Dlib**：面部特征点检测（68个关键点）
- **SciPy**：用于计算欧式距离等科学计算

### 用户界面
- **PyQt5**：图形用户界面开发框架
- **PyQt5-tools**：UI 设计工具

### 其他依赖
- **NumPy**：数组运算
- **Matplotlib/Seaborn**：数据可视化
- **PyYAML**：配置文件管理
- **Pillow**：图像处理和中文字体支持

## 项目结构

```
v4_gpu/
├── config/                          # 配置文件目录
│   └── configs.yaml                 # 系统配置文件
├── datasets/                        # 数据集目录
│   ├── train/                       # 训练集（5957张图片）
│   ├── valid/                       # 验证集（2389张图片）
│   ├── test/                        # 测试集（1538张图片）
│   └── data.yaml                    # 数据集配置文件
├── weights/                         # 模型权重目录
│   ├── best.pt                      # 训练好的最佳模型
│   └── shape_predictor_68_face_landmarks.dat  # Dlib面部特征点预测模型
├── icon/                            # 界面图标资源
├── output/                          # 检测结果输出目录
├── runs/                            # 训练记录
│   └── exp42/                       # 最新训练实验结果
├── test_media/                      # 测试媒体文件
├── tool/                            # 工具模块
│   ├── parser.py                    # 配置文件解析
│   └── tools.py                     # 工具函数（绘图、格式化等）
├── main.py                          # 主程序入口
├── UI.py                            # PyQt5 界面定义
├── UI.ui                            # Qt Designer 界面设计文件
├── train.py                         # 模型训练脚本
├── fatigue_detector.py              # 疲劳检测模块
├── myfatigue.py                     # 疲劳检测辅助函数
├── run_detection.py                 # 独立疲劳检测运行脚本
├── requirements.txt                 # Python 依赖包列表
└── README.md                        # 项目说明文档
```

## 安装说明

### 环境要求
- Python 3.8+
- CUDA 10.2+ （如需 GPU 加速）
- Windows/Linux/MacOS

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd v4_gpu
```

2. **创建虚拟环境（推荐）**
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **下载模型文件**
   - 确保 `weights/best.pt` 存在（YOLOv8 训练模型）
   - 确保 `weights/shape_predictor_68_face_landmarks.dat` 存在（Dlib 面部特征点模型）
   - 如需重新训练，请下载 `yolov8n.pt` 预训练模型

5. **配置系统**
   - 编辑 `config/configs.yaml` 文件，根据需要调整配置参数
   - 主要配置项：
     - `MODEL.DEVICE`: 设置为 '0'（使用第一块GPU）或 'cpu'
     - `MODEL.CONF`: 置信度阈值（默认 0.4）
     - `MODEL.IMGSIZE`: 输入图像大小（默认 640）

## 使用说明

### 启动图形界面

```bash
python main.py
```

### 使用步骤

1. **选择输入源**
   - 点击"选择图片文件"按钮：检测单张图片
   - 点击"选择图片文件夹"按钮：批量检测文件夹中的图片
   - 点击"选择视频文件"按钮：检测视频文件
   - 点击"打开摄像头"按钮：启用实时摄像头检测

2. **启用疲劳检测（可选）**
   - 在界面左侧勾选"启用疲劳检测"复选框
   - 仅在摄像头模式下有效
   - 系统将实时显示疲劳状态、眨眼次数、哈欠次数和 Perclos 评分

3. **开始检测**
   - 点击"开始运行 >"按钮启动检测
   - 对于视频和摄像头，再次点击可停止检测

4. **查看结果**
   - 主界面显示检测后的图像（标注了检测框）
   - 右侧显示详细信息：类别、置信度、位置坐标
   - 底部表格记录所有检测历史
   - 点击表格行可查看历史检测结果

5. **筛选目标**
   - 使用下拉列表选择特定目标类别
   - 可筛选显示特定类型的检测结果

6. **导出数据**
   - 点击"导出数据 >"按钮
   - 支持导出为 Excel (.xls) 或 CSV 格式
   - 导出内容包括：序号、图片名称、检测时间、结果、目标数量、用时、保存路径

### 独立疲劳检测（无 GUI）

如果只需要进行疲劳检测，可以运行独立脚本：

```bash
python run_detection.py
```

按 'Q' 键退出检测。

### 模型训练

如需重新训练模型：

1. 准备数据集（YOLO 格式）
2. 更新 `datasets/data.yaml` 中的路径
3. 运行训练脚本：

```bash
python train.py
```

训练参数：
- 预训练模型：`yolov8n.pt`
- 训练轮数：100 epochs
- 批次大小：2
- 数据集：`datasets/data.yaml`

训练结果将保存在 `runs/` 目录下。

## 配置说明

### config/configs.yaml

```yaml
MODEL:
  WEIGHT: 'weights/best.pt'      # 模型权重路径
  DEVICE: '0'                    # 设备选择：'cpu' 或 '0'（第一块GPU）
  CONF: 0.4                      # 置信度阈值
  CLASSES: None                  # 类别过滤（None表示检测所有类别）
  IMGSIZE: 640                   # 输入图像大小

UI:
  title: '驾驶员危险行为检测系统'
  # ... 其他界面配置

CONFIG:
  camera_num: 0                  # 摄像头ID
  chinese_name:                  # 类别中文名称映射
    'Open Eye': 'Open Eye'
    'Closed Eye': 'Closed Eye'
    'Cigarette': 'Cigarette'
    'Phone': 'Phone'
    'Seatbelt': 'Seatbelt'
```

## 疲劳检测原理

### 1. 眼睛长宽比（EAR - Eye Aspect Ratio）
```
EAR = (||p2-p6|| + ||p3-p5||) / (2 * ||p1-p4||)
```
- 当 EAR < 0.15 时判定为闭眼
- 连续 3 帧闭眼计为一次眨眼

### 2. 嘴巴长宽比（MAR - Mouth Aspect Ratio）
```
MAR = (||p2-p10|| + ||p4-p8||) / (2 * ||p1-p6||)
```
- 当 MAR > 0.65 时判定为打哈欠
- 连续 3 帧打哈欠计为一次哈欠

### 3. Perclos 疲劳评估模型
```
Perclos = (闭眼帧数 / 总帧数) + (打哈欠帧数 / 总帧数) × 权重
```
- 统计窗口：300 帧（约 10 秒 @ 30fps）
- 疲劳阈值：Perclos > 0.38
- 哈欠权重：0.25

### 4. 综合判定
系统综合考虑以下因素判定疲劳状态：
- 眨眼次数 ≥ 3 次 → 疲劳
- 哈欠次数 ≥ 3 次 → 疲劳
- Perclos 评分 > 0.38 → 疲劳
- 否则 → 清醒

## 性能优化

### GPU 加速
- 系统支持 CUDA GPU 加速
- 在 `config/configs.yaml` 中设置 `MODEL.DEVICE: '0'`
- GPU 加速可显著提升检测速度（约 10-20 倍）

### 多线程处理
- 主程序采用多线程架构
- 模型推理在独立线程中运行，不阻塞 UI 界面
- 确保实时检测的流畅性

### 内存管理
- 系统集成了内存监控功能
- 定期调用垃圾回收机制
- 避免长时间运行导致的内存泄漏

## 检测结果说明

### 输出文件
所有检测结果保存在 `output/YYYY_MM_DD_HH_MM_SS/` 目录下：
- `result.txt`：文本格式的检测记录
- `img_result/`：带标注的检测结果图片

### 结果格式
每条记录包含：
- 序号
- 图片名称/路径
- 录入时间
- 识别结果（类别、置信度、坐标）
- 目标数量
- 处理用时
- 保存路径

## 数据集说明

### 数据规模
- **训练集**：5,957 张图片
- **验证集**：2,389 张图片
- **测试集**：1,538 张图片
- **总计**：9,884 张标注图片

### 数据格式
- 图片格式：JPG
- 标注格式：YOLO TXT（每行：class x_center y_center width height）
- 类别数量：5 类

### 数据来源
数据集来源于真实驾驶场景，包含多种光照条件、角度和背景。

## 常见问题

### 1. 无法打开摄像头
- 检查摄像头是否被其他程序占用
- 尝试修改 `config/configs.yaml` 中的 `camera_num`（0, 1, 2...）
- 确保摄像头驱动正常安装

### 2. GPU 无法使用
- 检查 CUDA 和 cuDNN 是否正确安装
- 确认 PyTorch 版本支持当前 CUDA 版本
- 可切换到 CPU 模式：设置 `MODEL.DEVICE: 'cpu'`

### 3. 疲劳检测模型加载失败
- 确保 `weights/shape_predictor_68_face_landmarks.dat` 文件存在
- 该文件可从 Dlib 官网下载
- 检查文件路径是否正确

### 4. 中文显示乱码
- 疲劳检测需要 `SimHei.ttf` 字体文件
- 将字体文件放在项目根目录或系统字体目录
- 或者使用英文界面（修改配置文件）

### 5. 检测速度慢
- 优先使用 GPU 加速
- 降低输入图像大小（`MODEL.IMGSIZE`）
- 增加置信度阈值减少检测框数量

## 系统要求

### 最低配置
- CPU：Intel Core i5 或同等处理器
- 内存：8GB RAM
- 显卡：集成显卡（CPU 模式）
- 存储：5GB 可用空间

### 推荐配置
- CPU：Intel Core i7 或更高
- 内存：16GB RAM
- 显卡：NVIDIA GTX 1060 或更高（6GB+ 显存）
- 存储：10GB 可用空间（SSD 优先）

## 技术特点

1. **实时性能**：采用 YOLOv8 轻量级模型，保证实时检测速度
2. **高准确率**：经过 9000+ 张图片训练，模型具有较高的准确率
3. **多模态检测**：结合目标检测和面部特征点检测技术
4. **科学评估**：采用 Perclos 国际标准疲劳评估模型
5. **友好界面**：直观的图形界面，易于操作
6. **灵活配置**：支持多种参数调整和自定义配置
7. **数据导出**：便于后续分析和报告生成

## 应用场景

- **交通安全监管**：车队管理、运输公司驾驶员监控
- **智能驾驶**：辅助驾驶系统、驾驶员状态监测
- **科研教学**：计算机视觉、深度学习教学案例
- **毕业设计**：人工智能、智能交通方向毕业项目

## 未来改进方向

1. **模型优化**
   - 尝试更先进的检测模型（YOLOv9, YOLOv10）
   - 增加更多危险行为类别
   - 提升小目标检测能力

2. **功能扩展**
   - 增加声音报警功能
   - 支持多摄像头同时监控
   - 添加检测结果统计和分析模块
   - 开发移动端应用

3. **性能提升**
   - 模型量化和剪枝
   - 边缘设备部署（如 Jetson Nano）
   - 优化算法提升实时性能

4. **用户体验**
   - 更美观的界面设计
   - 支持多语言
   - 增加配置向导

## 许可证

本项目仅供学习和研究使用，请勿用于商业用途。

## 致谢

- **YOLOv8**: [Ultralytics](https://github.com/ultralytics/ultralytics)
- **Dlib**: [Dlib Library](http://dlib.net/)
- **PyQt5**: [Riverbank Computing](https://www.riverbankcomputing.com/software/pyqt/)
- 感谢提供数据集和技术支持的相关人员

## 联系方式

如有问题或建议，欢迎联系：
- 作者：Python图像识别
- 专业：人工智能研究院
- 学号：20240620

---

**注意**：本项目为毕业设计项目，代码和模型仅供参考学习。在实际应用中，请确保符合相关法律法规和隐私保护要求。

